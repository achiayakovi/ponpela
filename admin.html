<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¤×× ×œ × ×™×”×•×œ - ×¤×•× ×¤×œ×”</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Varela Round', sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #667eea; }
        .logout { 
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-number { font-size: 2.5rem; font-weight: 700; color: #667eea; }
        .stat-label { color: #7f8c8d; margin-top: 8px; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            background: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #7f8c8d;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .section { display: none; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section.active { display: block; }
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .filters input, .filters select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
        }
        .filters input { flex: 1; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #f0f0f0; }
        th { background: #f8f9fa; font-weight: 700; color: #667eea; }
        tr:hover { background: #f8f9fa; }
        select.status-select {
            padding: 5px 10px;
            border-radius: 20px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-edit { background: #3498db; color: white; }
        .btn-delete { background: #e74c3c; color: white; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ›ï¸ ×¤×× ×œ × ×™×”×•×œ - ×¤×•× ×¤×œ×”</h1>
            <button class="logout" onclick="logout()">×™×¦×™××”</button>
        </header>

        <div id="message" class="message" style="display:none;"></div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="pendingCount">-</div>
                <div class="stat-label">×××ª×™× ×™× ×œ××™×©×•×¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeCount">-</div>
                <div class="stat-label">××—×¨×™×•×ª ×‘×ª×•×§×£</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="ordersCount">-</div>
                <div class="stat-label">×”×–×× ×•×ª ×—×“×©×•×ª</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('warranties')">× ×™×”×•×œ ××—×¨×™×•×ª</button>
            <button class="tab" onclick="switchTab('orders')">×”×–×× ×•×ª</button>
            <button class="tab" onclick="switchTab('products')">××•×¦×¨×™×</button>
            <button class="tab" onclick="switchTab('users')">××©×ª××©×™×</button>
        </div>

        <div id="warrantiesSection" class="section active">
            <h2>× ×™×”×•×œ ××—×¨×™×•×ª</h2>
            <div class="filters">
                <input type="text" id="searchWarranties" placeholder="×—×™×¤×•×©..." oninput="filterWarranties()">
                <select id="filterStatus" onchange="filterWarranties()">
                    <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                    <option value="×××ª×™×Ÿ ×œ××™×©×•×¨">×××ª×™×Ÿ ×œ××™×©×•×¨</option>
                    <option value="×‘×ª×•×§×£">×‘×ª×•×§×£</option>
                    <option value="× ×“×—×”">× ×“×—×”</option>
                    <option value="×¤×’ ×ª×•×§×£">×¤×’ ×ª×•×§×£</option>
                </select>
            </div>
            <div id="warrantiesLoading" class="loading">×˜×•×¢×Ÿ...</div>
            <div id="warrantiesContent"></div>
        </div>

        <div id="ordersSection" class="section">
            <h2>× ×™×”×•×œ ×”×–×× ×•×ª</h2>
            <div id="ordersContent" class="loading">×˜×•×¢×Ÿ...</div>
        </div>

        <div id="productsSection" class="section">
            <h2>× ×™×”×•×œ ××•×¦×¨×™×</h2>
            <div id="productsContent" class="loading">×˜×•×¢×Ÿ...</div>
        </div>

        <div id="usersSection" class="section">
            <h2>× ×™×”×•×œ ××©×ª××©×™×</h2>
            <div id="usersContent" class="loading">×˜×•×¢×Ÿ...</div>
        </div>
    </div>

    <script>
        const API_URL = 'https://ponpela-backend-production.up.railway.app';
        let allWarranties = [];

        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/account.html';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/api/user/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await res.json();
                
                if (!user.is_admin) {
                    alert('××™×Ÿ ×œ×š ×”×¨×©××•×ª ××“××™×Ÿ');
                    window.location.href = '/account.html';
                    return;
                }

                loadDashboard();
            } catch (err) {
                window.location.href = '/account.html';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/account.html';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Section').classList.add('active');

            if (tab === 'warranties') loadWarranties();
            else if (tab === 'orders') loadOrders();
            else if (tab === 'products') loadProducts();
            else if (tab === 'users') loadUsers();
        }

        async function loadDashboard() {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/api/admin/warranties`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const warranties = await res.json();
            
            document.getElementById('pendingCount').textContent = 
                warranties.filter(w => w.status === '×××ª×™×Ÿ ×œ××™×©×•×¨').length;
            document.getElementById('activeCount').textContent = 
                warranties.filter(w => w.status === '×‘×ª×•×§×£').length;

            loadWarranties();
        }

        async function loadWarranties() {
            const token = localStorage.getItem('token');
            const loading = document.getElementById('warrantiesLoading');
            const content = document.getElementById('warrantiesContent');
            
            loading.style.display = 'block';
            content.innerHTML = '';

            try {
                const res = await fetch(`${API_URL}/api/admin/warranties`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                allWarranties = await res.json();
                loading.style.display = 'none';
                renderWarranties(allWarranties);
            } catch (err) {
                loading.innerHTML = '×©×’×™××” ×‘×˜×¢×™× ×”';
            }
        }

        function renderWarranties(warranties) {
            const content = document.getElementById('warrantiesContent');
            
            if (warranties.length === 0) {
                content.innerHTML = '<p style="text-align:center;padding:40px;color:#7f8c8d;">××™×Ÿ ××—×¨×™×•×ª</p>';
                return;
            }

            content.innerHTML = `
                <table>
                    <tr>
                        <th>××¡×¤×¨ ××›×©×™×¨</th>
                        <th>×©×</th>
                        <th>×˜×œ×¤×•×Ÿ</th>
                        <th>×ª××¨×™×š ×¨×›×™×©×”</th>
                        <th>×ª×•×§×£</th>
                        <th>×¡×˜×˜×•×¡</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                    ${warranties.map(w => `
                        <tr>
                            <td onclick="editMachineNumber(${w.id}, '${w.machine_number}')" style="cursor:pointer;text-decoration:underline;">${w.machine_number}</td>
                            <td>${w.customer_name}</td>
                            <td>${w.customer_phone}</td>
                            <td>${new Date(w.purchase_date).toLocaleDateString('he-IL')}</td>
                            <td>${new Date(w.expiry_date).toLocaleDateString('he-IL')}</td>
                            <td>
                                <select class="status-select" onchange="updateStatus(${w.id}, this.value)">
                                    <option value="×××ª×™×Ÿ ×œ××™×©×•×¨" ${w.status === '×××ª×™×Ÿ ×œ××™×©×•×¨' ? 'selected' : ''}>×××ª×™×Ÿ</option>
                                    <option value="×‘×ª×•×§×£" ${w.status === '×‘×ª×•×§×£' ? 'selected' : ''}>×‘×ª×•×§×£</option>
                                    <option value="× ×“×—×”" ${w.status === '× ×“×—×”' ? 'selected' : ''}>× ×“×—×”</option>
                                    <option value="×¤×’ ×ª×•×§×£" ${w.status === '×¤×’ ×ª×•×§×£' ? 'selected' : ''}>×¤×’ ×ª×•×§×£</option>
                                </select>
                            </td>
                            <td>
                                <button class="btn btn-delete" onclick="deleteWarranty(${w.id})">××—×§</button>
                            </td>
                        </tr>
                    `).join('')}
                </table>
            `;
        }

        function filterWarranties() {
            const search = document.getElementById('searchWarranties').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            
            let filtered = allWarranties;
            if (status) filtered = filtered.filter(w => w.status === status);
            if (search) {
                filtered = filtered.filter(w => 
                    w.machine_number.toLowerCase().includes(search) ||
                    w.customer_name.toLowerCase().includes(search) ||
                    w.customer_phone.includes(search)
                );
            }
            
            renderWarranties(filtered);
        }

        async function updateStatus(id, status) {
            const token = localStorage.getItem('token');
            try {
                await fetch(`${API_URL}/api/admin/warranty/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status })
                });
                showMessage('×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ', 'success');
                loadDashboard();
            } catch (err) {
                showMessage('×©×’×™××” ×‘×¢×“×›×•×Ÿ', 'error');
            }
        }

        function editMachineNumber(id, current) {
            const newNum = prompt('××¡×¤×¨ ××›×©×™×¨ ×—×“×©:', current);
            if (newNum && newNum !== current) {
                updateMachineNumber(id, newNum);
            }
        }

        async function updateMachineNumber(id, machine_number) {
            const token = localStorage.getItem('token');
            try {
                await fetch(`${API_URL}/api/admin/warranty/${id}/machine-number`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ machine_number })
                });
                showMessage('××¡×¤×¨ ××›×©×™×¨ ×¢×•×“×›×Ÿ', 'success');
                loadWarranties();
            } catch (err) {
                showMessage('×©×’×™××” ×‘×¢×“×›×•×Ÿ', 'error');
            }
        }

        async function deleteWarranty(id) {
            if (!confirm('×œ××—×•×§ ××—×¨×™×•×ª ×–×•?')) return;
            
            const token = localStorage.getItem('token');
            try {
                await fetch(`${API_URL}/api/admin/warranty/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                showMessage('× ××—×§', 'success');
                loadWarranties();
                loadDashboard();
            } catch (err) {
                showMessage('×©×’×™××” ×‘××—×™×§×”', 'error');
            }
        }

        async function loadOrders() {
            const token = localStorage.getItem('token');
            const content = document.getElementById('ordersContent');
            try {
                const res = await fetch(`${API_URL}/api/admin/orders`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const orders = await res.json();
                content.innerHTML = `<p>×¡×”"×› ${orders.length} ×”×–×× ×•×ª</p>`;
            } catch (err) {
                content.innerHTML = '×©×’×™××” ×‘×˜×¢×™× ×”';
            }
        }

        async function loadProducts() {
            const content = document.getElementById('productsContent');
            try {
                const res = await fetch(`${API_URL}/api/products`);
                const products = await res.json();
                content.innerHTML = `<p>×¡×”"×› ${products.length} ××•×¦×¨×™×</p>`;
            } catch (err) {
                content.innerHTML = '×©×’×™××” ×‘×˜×¢×™× ×”';
            }
        }

        async function loadUsers() {
            const content = document.getElementById('usersContent');
            content.innerHTML = '<p>×˜×•×¢×Ÿ...</p>';
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }

        checkAuth();
    </script>
</body>
</html>
