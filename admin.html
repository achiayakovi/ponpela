<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¤×× ×œ × ×™×”×•×œ - ×¤×•× ×¤×œ×”</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Varela Round', sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* Header */
        header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #667eea; font-size: 1.8rem; }
        .logout { 
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-number { font-size: 2.5rem; font-weight: 700; color: #667eea; }
        .stat-label { color: #7f8c8d; margin-top: 8px; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            background: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.3s;
        }
        .tab:hover { background: #ecf0f1; }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        /* Sections */
        .section { 
            display: none; 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .section.active { display: block; }
        .section h2 { color: #667eea; margin-bottom: 20px; }
        
        /* Filters & Actions */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
        }
        .filters {
            display: flex;
            gap: 10px;
            flex: 1;
        }
        .filters input, .filters select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
        }
        .filters input { flex: 1; min-width: 200px; }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        .btn-edit { background: #3498db; color: white; }
        .btn-delete { background: #e74c3c; color: white; }
        .btn-success { background: #27ae60; color: white; }
        
        /* Table */
        .table-container { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #ecf0f1;
        }
        th {
            background: #f8f9fa;
            font-weight: 700;
            color: #667eea;
            position: sticky;
            top: 0;
        }
        tr:hover { background: #f8f9fa; }
        .clickable {
            cursor: pointer;
            text-decoration: underline;
            color: #3498db;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 { color: #667eea; }
        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* Messages */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
        
        /* Loading & Empty */
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }
        
        /* Status Select */
        select.status-select {
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .form-row { grid-template-columns: 1fr; }
            .top-bar { flex-direction: column; }
            .filters { flex-direction: column; width: 100%; }
            .filters input { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>ğŸ›ï¸ ×¤×× ×œ × ×™×”×•×œ - ×¤×•× ×¤×œ×”</h1>
                <p style="color: #7f8c8d; margin-top: 5px;">×©×œ×•×, <span id="adminName">××“××™×Ÿ</span></p>
            </div>
            <button class="logout" onclick="logout()">×™×¦×™××”</button>
        </header>

        <div id="message" class="message" style="display:none;"></div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="pendingCount">-</div>
                <div class="stat-label">×××ª×™× ×™× ×œ××™×©×•×¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeCount">-</div>
                <div class="stat-label">××—×¨×™×•×ª ×‘×ª×•×§×£</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="ordersCount">-</div>
                <div class="stat-label">×”×–×× ×•×ª ×—×“×©×•×ª</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="usersCount">-</div>
                <div class="stat-label">××©×ª××©×™×</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('warranties')">××—×¨×™×•×ª</button>
            <button class="tab" onclick="switchTab('orders')">×”×–×× ×•×ª</button>
            <button class="tab" onclick="switchTab('products')">××•×¦×¨×™×</button>
            <button class="tab" onclick="switchTab('stock')">××œ××™</button>
            <button class="tab" onclick="switchTab('users')">××©×ª××©×™×</button>
        </div>

        <!-- Warranties Section -->
        <div id="warrantiesSection" class="section active">
            <h2>× ×™×”×•×œ ××—×¨×™×•×ª</h2>
            <div class="top-bar">
                <div class="filters">
                    <input type="text" id="searchWarranties" placeholder="×—×™×¤×•×©..." oninput="filterWarranties()">
                    <select id="filterStatus" onchange="filterWarranties()">
                        <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                        <option value="×××ª×™×Ÿ ×œ××™×©×•×¨">×××ª×™×Ÿ ×œ××™×©×•×¨</option>
                        <option value="×‘×ª×•×§×£">×‘×ª×•×§×£</option>
                        <option value="× ×“×—×”">× ×“×—×”</option>
                        <option value="×¤×’ ×ª×•×§×£">×¤×’ ×ª×•×§×£</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="exportWarrantiesToCSV()">ğŸ“¥ ×™×™×¦×•× CSV</button>
            </div>
            <div id="warrantiesLoading" class="loading">×˜×•×¢×Ÿ...</div>
            <div id="warrantiesContent"></div>
        </div>

        <!-- Orders Section -->
        <div id="ordersSection" class="section">
            <h2>× ×™×”×•×œ ×”×–×× ×•×ª</h2>
            <div id="ordersLoading" class="loading">×˜×•×¢×Ÿ...</div>
            <div id="ordersContent"></div>
        </div>

        <!-- Products Section -->
        <div id="productsSection" class="section">
            <h2>× ×™×”×•×œ ××•×¦×¨×™×</h2>
            <button class="btn btn-primary" onclick="openProductModal()" style="margin-bottom: 20px;">+ ×”×•×¡×¤×ª ××•×¦×¨</button>
            <div id="productsLoading" class="loading">×˜×•×¢×Ÿ...</div>
            <div id="productsContent"></div>
        </div>

        <!-- Stock Section -->
        <div id="stockSection" class="section">
            <h2>× ×™×”×•×œ ××œ××™</h2>
            
            <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3>×”×ª×¨××•×ª ××œ××™ × ××•×š</h3>
                <div id="lowStockLoading" class="loading">×˜×•×¢×Ÿ...</div>
                <div id="lowStockContent"></div>
            </div>

            <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3>×¢×“×›×•×Ÿ ××œ××™ ×™×“× ×™</h3>
                <form id="updateStockForm" onsubmit="updateStock(event)" style="display: flex; gap: 10px; align-items: end;">
                    <div class="form-group" style="flex: 2;">
                        <label>×‘×—×¨ ××•×¦×¨</label>
                        <select id="stockProductId" required></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>×©×™× ×•×™ ×›××•×ª (+/-)</label>
                        <input type="number" id="stockChangeAmount" required placeholder="5 ××• -3">
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>×¡×™×‘×”</label>
                        <input type="text" id="stockReason" placeholder="××•×¤×¦×™×•× ×œ×™">
                    </div>
                    <button type="submit" class="btn btn-primary">×¢×“×›×Ÿ</button>
                </form>
            </div>

            <div style="background: white; padding: 20px; border-radius: 10px;">
                <h3>×œ×•×’ ×©×™× ×•×™×™ ××œ××™</h3>
                <div id="stockLogsLoading" class="loading">×˜×•×¢×Ÿ...</div>
                <div id="stockLogsContent"></div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="usersSection" class="section">
            <h2>× ×™×”×•×œ ××©×ª××©×™×</h2>
            <div id="usersLoading" class="loading">×˜×•×¢×Ÿ...</div>
            <div id="usersContent"></div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">×”×•×¡×¤×ª ××•×¦×¨</h3>
                <button class="close-modal" onclick="closeProductModal()">Ã—</button>
            </div>
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="productId">
                
                <div class="form-group">
                    <label>×©× ×”××•×¦×¨ *</label>
                    <input type="text" id="productName" required>
                </div>
                
                <div class="form-group">
                    <label>SKU (×§×•×“ ××•×¦×¨)</label>
                    <input type="text" id="productSku" placeholder="PUMP-S35-WHT">
                </div>
                
                <div class="form-group">
                    <label>×§×˜×’×•×¨×™×”</label>
                    <select id="productCategory">
                        <option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”</option>
                        <option value="××©××‘×•×ª ×—×©××œ×™×•×ª">××©××‘×•×ª ×—×©××œ×™×•×ª</option>
                        <option value="××‘×™×–×¨×™× ×•×—×œ×¤×™×">××‘×™×–×¨×™× ×•×—×œ×¤×™×</option>
                        <option value="××—×¡×•×Ÿ ×—×œ×‘">××—×¡×•×Ÿ ×—×œ×‘</option>
                        <option value="××ª× ×•×ª">××ª× ×•×ª</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>×ª×™××•×¨ ×§×¦×¨</label>
                    <input type="text" id="productShortDescription" placeholder="××©×¤×˜ ××—×“ ×¢×œ ×”××•×¦×¨" maxlength="200">
                </div>
                
                <div class="form-group">
                    <label>×ª×™××•×¨ ××œ×</label>
                    <textarea id="productDescription" rows="4"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>××—×™×¨ ×¨×’×™×œ *</label>
                        <input type="number" id="productPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>××—×™×¨ ××‘×¦×¢</label>
                        <input type="number" id="productSalePrice" step="0.01" placeholder="××•×¤×¦×™×•× ×œ×™">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>××œ×œ ××—×™×¨ (××•×¤×¦×™×•× ×œ×™)</label>
                    <input type="text" id="productPriceLabel" placeholder='×œ×“×•×’××”: "××‘×¦×¢!", "×”×—×œ ×-"'>
                </div>
                
                <div class="form-group">
                    <label>×§×™×©×•×¨ ×œ×ª××•× ×”</label>
                    <input type="text" id="productImage">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>×›××•×ª ×‘××œ××™ *</label>
                        <input type="number" id="productStockQuantity" value="0" required>
                    </div>
                    <div class="form-group">
                        <label>×ª×’ ××™×•×—×“</label>
                        <select id="productBadge">
                            <option value="">×œ×œ×</option>
                            <option value="×—×“×©">×—×“×©!</option>
                            <option value="××‘×¦×¢">××‘×¦×¢!</option>
                            <option value="×¤×•×¤×•×œ×¨×™">×¤×•×¤×•×œ×¨×™</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>×‘××œ××™</label>
                        <select id="productInStock">
                            <option value="true">×›×Ÿ</option>
                            <option value="false">×œ×</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>×™×© ××—×¨×™×•×ª</label>
                        <select id="productHasWarranty">
                            <option value="false">×œ×</option>
                            <option value="true">×›×Ÿ (×©× ×” ×•×™×•×)</option>
                        </select>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">×©××•×¨</button>
            </form>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal" id="resetPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>××™×¤×•×¡ ×¡×™×¡××”</h3>
                <button class="close-modal" onclick="closeResetPasswordModal()">Ã—</button>
            </div>
            <form id="resetPasswordForm" onsubmit="resetPassword(event)">
                <input type="hidden" id="resetUserEmail">
                <p style="margin-bottom: 20px;">××©×ª××©: <strong id="resetUserName"></strong></p>
                <div class="form-group">
                    <label>×¡×™×¡××” ×—×“×©×” *</label>
                    <input type="password" id="newPassword" minlength="6" required>
                </div>
                <button type="submit" class="btn btn-primary">×©× ×” ×¡×™×¡××”</button>
            </form>
        </div>
    </div>

    <!-- Assign User Modal -->
    <div class="modal" id="assignUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×©×™×•×š ×œ××©×ª××©</h3>
                <button class="close-modal" onclick="closeAssignUserModal()">Ã—</button>
            </div>
            <form id="assignUserForm" onsubmit="assignUser(event)">
                <input type="hidden" id="assignWarrantyId">
                <div class="form-group">
                    <label>×‘×—×¨ ××©×ª××©</label>
                    <select id="assignUserId">
                        <option value="">×œ×œ× ××©×ª××©</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">×©×™×™×š</button>
            </form>
        </div>
    </div>

    <!-- Edit Dates Modal -->
    <div class="modal" id="editDatesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×¢×¨×™×›×ª ×ª××¨×™×›×™×</h3>
                <button class="close-modal" onclick="closeEditDatesModal()">Ã—</button>
            </div>
            <form id="editDatesForm" onsubmit="saveDates(event)">
                <input type="hidden" id="datesWarrantyId">
                <div class="form-group">
                    <label>×ª××¨×™×š ×¨×›×™×©×”</label>
                    <input type="date" id="editPurchaseDate" required>
                </div>
                <div class="form-group">
                    <label>×ª×•×§×£ ××—×¨×™×•×ª</label>
                    <input type="date" id="editExpiryDate" required>
                </div>
                <button type="submit" class="btn btn-primary">×©××•×¨</button>
            </form>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×¤×¨×˜×™ ×”×–×× ×”</h3>
                <button class="close-modal" onclick="closeOrderModal()">Ã—</button>
            </div>
            <div id="orderDetails"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://ponpela-backend-production.up.railway.app';
        let allWarranties = [];
        let allUsers = [];
        let currentProduct = null;

        // Auth Check
        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/account.html';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/api/user/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await res.json();
                
                if (!user.is_admin) {
                    alert('××™×Ÿ ×œ×š ×”×¨×©××•×ª ××“××™×Ÿ');
                    window.location.href = '/account.html';
                    return;
                }

                document.getElementById('adminName').textContent = user.full_name;
                loadDashboard();
                
            } catch (err) {
                window.location.href = '/account.html';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/account.html';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Section').classList.add('active');

            if (tab === 'warranties') loadWarranties();
            else if (tab === 'orders') loadOrders();
            else if (tab === 'products') loadProducts();
            else if (tab === 'stock') loadStock();
            else if (tab === 'users') loadUsers();
        }

        async function loadDashboard() {
            const token = localStorage.getItem('token');
            
            try {
                const [warranties, orders, users] = await Promise.all([
                    fetch(`${API_URL}/api/admin/warranties`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json()),
                    fetch(`${API_URL}/api/admin/orders`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json()),
                    fetch(`${API_URL}/api/admin/users`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json())
                ]);
                
                document.getElementById('pendingCount').textContent = 
                    warranties.filter(w => w.status === '×××ª×™×Ÿ ×œ××™×©×•×¨').length;
                document.getElementById('activeCount').textContent = 
                    warranties.filter(w => w.status === '×‘×ª×•×§×£').length;
                document.getElementById('ordersCount').textContent = 
                    orders.filter(o => o.status === 'pending').length;
                document.getElementById('usersCount').textContent = users.length;

                allUsers = users;
                loadWarranties();
                
            } catch (err) {
                console.error('Dashboard error:', err);
            }
        }

        // Warranties
        async function loadWarranties() {
            const token = localStorage.getItem('token');
            const loading = document.getElementById('warrantiesLoading');
            const content = document.getElementById('warrantiesContent');
            
            loading.style.display = 'block';
            content.innerHTML = '';

            try {
                const res = await fetch(`${API_URL}/api/admin/warranties`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                allWarranties = await res.json();
                loading.style.display = 'none';
                renderWarranties(allWarranties);
            } catch (err) {
                loading.innerHTML = '×©×’×™××” ×‘×˜×¢×™× ×”';
            }
        }

        function renderWarranties(warranties) {
            const content = document.getElementById('warrantiesContent');
            
            if (warranties.length === 0) {
                content.innerHTML = '<p class="empty-state">××™×Ÿ ××—×¨×™×•×ª</p>';
                return;
            }

            content.innerHTML = `
                <div class="table-container">
                    <table>
                        <tr>
                            <th>××¡×¤×¨ ××›×©×™×¨</th>
                            <th>×©×</th>
                            <th>×˜×œ×¤×•×Ÿ</th>
                            <th>×ª××¨×™×š ×¨×›×™×©×”</th>
                            <th>×ª×•×§×£</th>
                            <th>×¡×˜×˜×•×¡</th>
                            <th>××©×ª××©</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                        ${warranties.map(w => `
                            <tr>
                                <td class="clickable" onclick="editMachineNumber(${w.id}, '${w.machine_number}')">${w.machine_number}</td>
                                <td>${w.customer_name}</td>
                                <td>${w.customer_phone}</td>
                                <td class="clickable" onclick="openEditDatesModal(${w.id}, '${w.purchase_date}', '${w.expiry_date}')">${new Date(w.purchase_date).toLocaleDateString('he-IL')}</td>
                                <td>${new Date(w.expiry_date).toLocaleDateString('he-IL')}</td>
                                <td>
                                    <select class="status-select" onchange="updateStatus(${w.id}, this.value)">
                                        <option value="×××ª×™×Ÿ ×œ××™×©×•×¨" ${w.status === '×××ª×™×Ÿ ×œ××™×©×•×¨' ? 'selected' : ''}>×××ª×™×Ÿ</option>
                                        <option value="×‘×ª×•×§×£" ${w.status === '×‘×ª×•×§×£' ? 'selected' : ''}>×‘×ª×•×§×£</option>
                                        <option value="× ×“×—×”" ${w.status === '× ×“×—×”' ? 'selected' : ''}>× ×“×—×”</option>
                                        <option value="×¤×’ ×ª×•×§×£" ${w.status === '×¤×’ ×ª×•×§×£' ? 'selected' : ''}>×¤×’ ×ª×•×§×£</option>
                                    </select>
                                </td>
                                <td>
                                    <span class="clickable" onclick="openAssignUserModal(${w.id}, ${w.user_id})">${w.user_id ? '×©×•×™×š' : '×œ× ×©×•×™×š'}</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-delete" onclick="deleteWarranty(${w.id})">××—×§</button>
                                </td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `;
        }

        function filterWarranties() {
            const search = document.getElementById('searchWarranties').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            
            let filtered = allWarranties;
            if (status) filtered = filtered.filter(w => w.status === status);
            if (search) {
                filtered = filtered.filter(w => 
                    w.machine_number.toLowerCase().includes(search) ||
                    w.customer_name.toLowerCase().includes(search) ||
                    w.customer_phone.includes(search)
                );
            }
            renderWarranties(filtered);
        }

        async function updateStatus(id, status) {
            const token = localStorage.getItem('token');
            try {
                await fetch(`${API_URL}/api/admin/warranty/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status })
                });
                showMessage('×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ', 'success');
                loadDashboard();
            } catch (err) {
                showMessage('×©×’×™××”', 'error');
            }
        }

        function editMachineNumber(id, current) {
            const newNum = prompt('××¡×¤×¨ ××›×©×™×¨ ×—×“×©:', current);
            if (newNum && newNum !== current) {
                updateMachineNumber(id, newNum);
            }
        }

        async function updateMachineNumber(id, machine_number) {
            const token = localStorage.getItem('token');
            try {
                await fetch(`${API_URL}/api/admin/warranty/${id}/machine-number`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ machine_number })
                });
                showMessage('××¡×¤×¨ ××›×©×™×¨ ×¢×•×“×›×Ÿ', 'success');
                loadWarranties();
            } catch (err) {
                showMessage('×©×’×™××”', 'error');
            }
        }

        async function deleteWarranty(id) {
            if (!confirm('×œ××—×•×§ ××—×¨×™×•×ª ×–×•?')) return;
            const token = localStorage.getItem('token');
            try {
                await fetch(`${API_URL}/api/admin/warranty/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                showMessage('× ××—×§', 'success');
                loadWarranties();
                loadDashboard();
            } catch (err) {
                showMessage('×©×’×™××”', 'error');
            }
        }

        function exportWarrantiesToCSV() {
            if (allWarranties.length === 0) {
                alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×');
                return;
            }

            const headers = ['××¡×¤×¨ ××›×©×™×¨', '×©×', '×˜×œ×¤×•×Ÿ', '×ª××¨×™×š ×¨×›×™×©×”', '×ª×•×§×£', '×¡×˜×˜×•×¡'];
            const rows = allWarranties.map(w => [
                w.machine_number,
                w.customer_name,
                w.customer_phone,
                new Date(w.purchase_date).toLocaleDateString('he-IL'),
                new Date(w.expiry_date).toLocaleDateString('he-IL'),
                w.status
            ]);

            let csv = '\uFEFF' + headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `warranties_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Assign User Modal
        function openAssignUserModal(warrantyId, currentUserId) {
            document.getElementById('assignWarrantyId').value = warrantyId;
            
            const select = document.getElementById('assignUserId');
            select.innerHTML = '<option value="">×œ×œ× ××©×ª××©</option>';
            allUsers.forEach(u => {
                const option = document.createElement('option');
                option.value = u.id;
                option.textContent = `${u.full_name} (${u.email})`;
                if (u.id === currentUserId) option.selected = true;
                select.appendChild(option);
            });
            
            document.getElementById('assignUserModal').classList.add('active');
        }

        function closeAssignUserModal() {
            document.getElementById('assignUserModal').classList.remove('active');
        }

        async function assignUser(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const warrantyId = document.getElementById('assignWarrantyId').value;
            const userId = document.getElementById('assignUserId').value || null;
            
            try {
                await fetch(`${API_URL}/api/admin/warranty/${warrantyId}/assign-user`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ user_id: userId })
                });
                showMessage('××©×ª××© ×©×•×™×š', 'success');
                closeAssignUserModal();
                loadWarranties();
            } catch (err) {
                showMessage('×©×’×™××”', 'error');
            }
        }

        // Edit Dates Modal
        function openEditDatesModal(warrantyId, purchaseDate, expiryDate) {
            document.getElementById('datesWarrantyId').value = warrantyId;
            document.getElementById('editPurchaseDate').value = purchaseDate.split('T')[0];
            document.getElementById('editExpiryDate').value = expiryDate.split('T')[0];
            document.getElementById('editDatesModal').classList.add('active');
        }

        function closeEditDatesModal() {
            document.getElementById('editDatesModal').classList.remove('active');
        }

        async function saveDates(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const warrantyId = document.getElementById('datesWarrantyId').value;
            const purchaseDate = document.getElementById('editPurchaseDate').value;
            const expiryDate = document.getElementById('editExpiryDate').value;
            
            try {
                await fetch(`${API_URL}/api/admin/warranty/${warrantyId}/dates`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ purchase_date: purchaseDate, expiry_date: expiryDate })
                });
                showMessage('×ª××¨×™×›×™× ×¢×•×“×›× ×•', 'success');
                closeEditDatesModal();
                loadWarranties();
            } catch (err) {
                showMessage('×©×’×™××”', 'error');
            }
        }

        // Products
        async function loadProducts() {
            const token = localStorage.getItem('token');
            const loading = document.getElementById('productsLoading');
            const content = document.getElementById('productsContent');
            
            loading.style.display = 'block';
            content.innerHTML = '';

            try {
                const res = await fetch(`${API_URL}/api/products`);
                const products = await res.json();
                loading.style.display = 'none';
                
                if (products.length === 0) {
                    content.innerHTML = '<p class="empty-state">××™×Ÿ ××•×¦×¨×™×</p>';
                    return;
                }

                content.innerHTML = `
                    <div class="table-container">
                        <table>
                            <tr>
                                <th>×©×</th>
                                <th>SKU</th>
                                <th>×§×˜×’×•×¨×™×”</th>
                                <th>××—×™×¨</th>
                                <th>××œ××™</th>
                                <th>×¡×˜×˜×•×¡</th>
                                <th>×ª×’</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                            ${products.map(p => `
                                <tr>
                                    <td>${p.name}</td>
                                    <td>${p.sku || '-'}</td>
                                    <td>${p.category || '-'}</td>
                                    <td>
                                        ${p.sale_price ? 
                                            `<span style="text-decoration: line-through; color: gray;">â‚ª${p.price}</span><br>
                                             <span style="color: red; font-weight: bold;">â‚ª${p.sale_price}</span>` :
                                            `â‚ª${p.price}`}
                                    </td>
                                    <td style="font-weight: bold; color: ${
                                        p.stock_quantity === 0 ? 'red' : 
                                        p.stock_quantity <= 10 ? 'orange' : 
                                        'green'
                                    };">
                                        ${p.stock_quantity}
                                    </td>
                                    <td>
                                        ${p.stock_quantity === 0 ? 
                                            '<span style="color: red;">ğŸ”´ ××–×œ</span>' : 
                                            '<span style="color: green;">ğŸŸ¢ ×‘××œ××™</span>'}
                                    </td>
                                    <td>${p.badge ? `<span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">${p.badge}</span>` : '-'}</td>
                                    <td>
                                        <button class="btn btn-sm btn-edit" onclick="editProduct(${p.id})">×¢×¨×•×š</button>
                                        <button class="btn btn-sm btn-delete" onclick="deleteProduct(${p.id})">××—×§</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                `;
            } catch (err) {
                loading.innerHTML = '×©×’×™××”';
            }
        }

        function openProductModal(product = null) {
            const modal = document.getElementById('productModal');
            const title = document.getElementById('productModalTitle');
            
            if (product) {
                title.textContent = '×¢×¨×™×›×ª ××•×¦×¨';
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productSku').value = product.sku || '';
                document.getElementById('productCategory').value = product.category || '';
                document.getElementById('productShortDescription').value = product.short_description || '';
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productSalePrice').value = product.sale_price || '';
                document.getElementById('productPriceLabel').value = product.price_label || '';
                document.getElementById('productImage').value = product.image_url || '';
                document.getElementById('productStockQuantity').value = product.stock_quantity || 0;
                document.getElementById('productBadge').value = product.badge || '';
                document.getElementById('productInStock').value = product.in_stock.toString();
                document.getElementById('productHasWarranty').value = product.has_warranty.toString();
            } else {
                title.textContent = '×”×•×¡×¤×ª ××•×¦×¨';
                document.getElementById('productForm').reset();
                document.getElementById('productId').value = '';
                document.getElementById('productStockQuantity').value = '0';
            }
            
            modal.classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        async function saveProduct(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const id = document.getElementById('productId').value;
            
            const productData = {
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                short_description: document.getElementById('productShortDescription').value,
                price: parseFloat(document.getElementById('productPrice').value),
                sale_price: document.getElementById('productSalePrice').value ? 
                           parseFloat(document.getElementById('productSalePrice').value) : null,
                price_label: document.getElementById('productPriceLabel').value || null,
                image_url: document.getElementById('productImage').value,
                stock_quantity: parseInt(document.getElementById('productStockQuantity').value) || 0,
                category: document.getElementById('productCategory').value || null,
                sku: document.getElementById('productSku').value || null,
                badge: document.getElementById('productBadge').value || null,
                in_stock: document.getElementById('productInStock').value === 'true',
                has_warranty: document.getElementById('productHasWarranty').value === 'true'
            };

            try {
                const url = id ? `${API_URL}/api/admin/products/${id}` : `${API_URL}/api/admin/products`;
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(productData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '×©×’×™××”');
                }

                showMessage(id ? '××•×¦×¨ ×¢×•×“×›×Ÿ' : '××•×¦×¨ × ×•×¡×£', 'success');
                closeProductModal();
                loadProducts();
            } catch (err) {
                showMessage(err.message || '×©×’×™××”', 'error');
            }
        }

        async function editProduct(id) {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_URL}/api/admin/products/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const product = await res.json();
                openProductModal(product);
            } catch (err) {
                showMessage('×©×’×™××”', 'error');
            }
        }

        async function deleteProduct(id) {
            if (!confirm('×œ××—×•×§ ××•×¦×¨ ×–×”?')) return;
            const token = localStorage.getItem('token');
            try {
                await fetch(`${API_URL}/api/admin/products/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                showMessage('××•×¦×¨ × ××—×§', 'success');
                loadProducts();
            } catch (err) {
                showMessage('×©×’×™××”', 'error');
            }
        }

        // Orders
        async function loadOrders() {
            const token = localStorage.getItem('token');
            const loading = document.getElementById('ordersLoading');
            const content = document.getElementById('ordersContent');
            
            loading.style.display = 'block';
            content.innerHTML = '';

            try {
                const res = await fetch(`${API_URL}/api/admin/orders`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const orders = await res.json();
                loading.style.display = 'none';
                
                if (orders.length === 0) {
                    content.innerHTML = '<p class="empty-state">××™×Ÿ ×”×–×× ×•×ª</p>';
                    return;
                }

                content.innerHTML = `
                    <div class="table-container">
                        <table>
                            <tr>
                                <th>××¡×¤×¨</th>
                                <th>×œ×§×•×—</th>
                                <th>×¡×›×•×</th>
                                <th>×¡×˜×˜×•×¡</th>
                                <th>×ª××¨×™×š</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                            ${orders.map(o => `
                                <tr>
                                    <td>#${o.id}</td>
                                    <td>${o.full_name || o.email}</td>
                                    <td>â‚ª${o.total_amount}</td>
                                    <td>
                                        <select class="status-select" onchange="updateOrderStatus(${o.id}, this.value)">
                                            <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>×××ª×™×Ÿ</option>
                                            <option value="completed" ${o.status === 'completed' ? 'selected' : ''}>×”×•×©×œ×</option>
                                            <option value="cancelled" ${o.status === 'cancelled' ? 'selected' : ''}>×‘×•×˜×œ</option>
                                        </select>
                                    </td>
                                    <td>${new Date(o.created_at).toLocaleDateString('he-IL')}</td>
                                    <td>
                                        <button class="btn btn-sm btn-edit" onclick="viewOrder(${o.id})">×¦×¤×”</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                `;
            } catch (err) {
                loading.innerHTML = '×©×’×™××”';
            }
        }

        async function updateOrderStatus(id, status) {
            const token = localStorage.getItem('token');
            try {
                await fetch(`${API_URL}/api/admin/orders/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status })
                });
                showMessage('×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ', 'success');
            } catch (err) {
                showMessage('×©×’×™××”', 'error');
            }
        }

        async function viewOrder(id) {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_URL}/api/admin/order/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const order = await res.json();
                
                const details = `
                    <div>
                        <p><strong>×œ×§×•×—:</strong> ${order.full_name}</p>
                        <p><strong>××™××™×™×œ:</strong> ${order.email}</p>
                        <p><strong>×˜×œ×¤×•×Ÿ:</strong> ${order.phone || '-'}</p>
                        <p><strong>×›×ª×•×‘×ª:</strong> ${order.shipping_address || '-'}</p>
                        <p><strong>×¡×›×•×:</strong> â‚ª${order.total_amount}</p>
                        <p><strong>×¡×˜×˜×•×¡:</strong> ${order.status}</p>
                        <h4 style="margin-top: 20px;">××•×¦×¨×™×:</h4>
                        <table style="width:100%; margin-top:10px;">
                            <tr><th>××•×¦×¨</th><th>×›××•×ª</th><th>××—×™×¨</th></tr>
                            ${order.items.map(item => `
                                <tr>
                                    <td>${item.product_name}</td>
                                    <td>${item.quantity}</td>
                                    <td>â‚ª${item.price}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                `;
                
                document.getElementById('orderDetails').innerHTML = details;
                document.getElementById('orderModal').classList.add('active');
            } catch (err) {
                showMessage('×©×’×™××”', 'error');
            }
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        // Users
        async function loadUsers() {
            const token = localStorage.getItem('token');
            const loading = document.getElementById('usersLoading');
            const content = document.getElementById('usersContent');
            
            loading.style.display = 'block';
            content.innerHTML = '';

            try {
                const res = await fetch(`${API_URL}/api/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const users = await res.json();
                loading.style.display = 'none';

                content.innerHTML = `
                    <div class="table-container">
                        <table>
                            <tr>
                                <th>×©×</th>
                                <th>××™××™×™×œ</th>
                                <th>×˜×œ×¤×•×Ÿ</th>
                                <th>××“××™×Ÿ</th>
                                <th>×ª××¨×™×š ×”×¦×˜×¨×¤×•×ª</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                            ${users.map(u => `
                                <tr>
                                    <td>${u.full_name}</td>
                                    <td>${u.email}</td>
                                    <td>${u.phone || '-'}</td>
                                    <td>${u.is_admin ? 'âœ“' : 'âœ—'}</td>
                                    <td>${new Date(u.created_at).toLocaleDateString('he-IL')}</td>
                                    <td>
                                        <button class="btn btn-sm btn-edit" onclick="openResetPasswordModal('${u.email}', '${u.full_name}')">××™×¤×•×¡ ×¡×™×¡××”</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                `;
            } catch (err) {
                loading.innerHTML = '×©×’×™××”';
            }
        }

        function openResetPasswordModal(email, name) {
            document.getElementById('resetUserEmail').value = email;
            document.getElementById('resetUserName').textContent = name;
            document.getElementById('newPassword').value = '';
            document.getElementById('resetPasswordModal').classList.add('active');
        }

        function closeResetPasswordModal() {
            document.getElementById('resetPasswordModal').classList.remove('active');
        }

        async function resetPassword(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const email = document.getElementById('resetUserEmail').value;
            const newPassword = document.getElementById('newPassword').value;
            
            try {
                await fetch(`${API_URL}/api/admin/reset-user-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ user_email: email, new_password: newPassword })
                });
                showMessage('×¡×™×¡××” ××•×¤×¡×”', 'success');
                closeResetPasswordModal();
            } catch (err) {
                showMessage('×©×’×™××”', 'error');
            }
        }

        // ===== Stock Management =====

        async function loadStock() {
            await loadProductsForStockSelect();
            await loadLowStock();
            await loadStockLogs();
        }

        async function loadProductsForStockSelect() {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_URL}/api/products`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const products = await res.json();
                
                const select = document.getElementById('stockProductId');
                select.innerHTML = '<option value="">×‘×—×¨ ××•×¦×¨</option>' +
                    products.map(p => `<option value="${p.id}">${p.name} (××œ××™ × ×•×›×—×™: ${p.stock_quantity})</option>`).join('');
            } catch (err) {
                console.error(err);
            }
        }

        async function loadLowStock() {
            const token = localStorage.getItem('token');
            const loading = document.getElementById('lowStockLoading');
            const content = document.getElementById('lowStockContent');
            
            loading.style.display = 'block';
            content.innerHTML = '';

            try {
                const res = await fetch(`${API_URL}/api/admin/low-stock?threshold=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const products = await res.json();
                loading.style.display = 'none';

                if (products.length === 0) {
                    content.innerHTML = '<p style="color: green;">âœ“ ×›×œ ×”××•×¦×¨×™× ×‘××œ××™ ×ª×§×™×Ÿ</p>';
                    return;
                }

                content.innerHTML = `
                    <div class="table-container">
                        <table>
                            <tr>
                                <th>××•×¦×¨</th>
                                <th>SKU</th>
                                <th>××œ××™ × ×•×›×—×™</th>
                                <th>×¡×˜×˜×•×¡</th>
                            </tr>
                            ${products.map(p => `
                                <tr>
                                    <td>${p.name}</td>
                                    <td>${p.sku || '-'}</td>
                                    <td style="font-weight: bold; color: ${p.stock_quantity === 0 ? 'red' : 'orange'};">
                                        ${p.stock_quantity}
                                    </td>
                                    <td>
                                        ${p.stock_quantity === 0 ? 
                                            '<span style="color: red;">âš ï¸ ××–×œ!</span>' : 
                                            '<span style="color: orange;">âš ï¸ × ××•×š</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                `;
            } catch (err) {
                loading.style.display = 'none';
                content.innerHTML = '<p style="color: red;">×©×’×™××” ×‘×˜×¢×™× ×ª ××œ××™</p>';
            }
        }

        async function loadStockLogs() {
            const token = localStorage.getItem('token');
            const loading = document.getElementById('stockLogsLoading');
            const content = document.getElementById('stockLogsContent');
            
            loading.style.display = 'block';
            content.innerHTML = '';

            try {
                const res = await fetch(`${API_URL}/api/admin/stock-logs`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const logs = await res.json();
                loading.style.display = 'none';

                if (logs.length === 0) {
                    content.innerHTML = '<p>××™×Ÿ ×©×™× ×•×™×™ ××œ××™</p>';
                    return;
                }

                content.innerHTML = `
                    <div class="table-container">
                        <table>
                            <tr>
                                <th>×ª××¨×™×š</th>
                                <th>××•×¦×¨</th>
                                <th>×©×™× ×•×™</th>
                                <th>×¡×™×‘×”</th>
                                <th>×¢×œ ×™×“×™</th>
                            </tr>
                            ${logs.map(log => `
                                <tr>
                                    <td>${new Date(log.created_at).toLocaleString('he-IL')}</td>
                                    <td>${log.product_name}</td>
                                    <td style="color: ${log.change_amount > 0 ? 'green' : 'red'}; font-weight: bold;">
                                        ${log.change_amount > 0 ? '+' : ''}${log.change_amount}
                                    </td>
                                    <td>${log.reason || '-'}</td>
                                    <td>${log.admin_name || '××¢×¨×›×ª'}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                `;
            } catch (err) {
                loading.style.display = 'none';
                content.innerHTML = '<p style="color: red;">×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×•×’</p>';
            }
        }

        async function updateStock(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            
            const product_id = parseInt(document.getElementById('stockProductId').value);
            const change_amount = parseInt(document.getElementById('stockChangeAmount').value);
            const reason = document.getElementById('stockReason').value;

            if (!product_id) {
                showMessage('× × ×œ×‘×—×•×¨ ××•×¦×¨', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/api/admin/update-stock`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ product_id, change_amount, reason })
                });

                if (!res.ok) throw new Error('×©×’×™××”');

                showMessage('××œ××™ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”', 'success');
                document.getElementById('updateStockForm').reset();
                await loadStock();
                await loadProducts(); // refresh products tab
            } catch (err) {
                showMessage('×©×’×™××” ×‘×¢×“×›×•×Ÿ ××œ××™', 'error');
            }
        }

        // Utility
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }

        // Init
        checkAuth();
    </script>
</body>
</html>
